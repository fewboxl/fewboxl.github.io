import Konva from 'konva';
import * as React from 'react';
import { Den } from '../../../..';
//import { Den } from '../../../..';
import Base, { IBaseProps } from '../../Engine/Base';
import { autoSize, getSize, ISize } from '../../Layout/util';
import VDesignerGroup, { IVDesignerGroupProps } from './VDesignerGroup';
import { DesignerNodeType } from './VDesignerNode';
import VDesignerElement, { IVDesignerElementProps } from './VDesignerElement';
import { Property } from 'csstype';
import VDesignerConnection, { IVDesignerConnectionProps } from './VDesignerConnection';

type TLength = (string & {}) | 0;

export interface IVDesignerProps extends IBaseProps {
    containerName?: string;
    nodeItems?: (IVDesignerElementProps | IVDesignerGroupProps | IVDesignerConnectionProps)[];
    isAutoSize?: boolean;
    autosizeHeight: Property.Height<TLength>;
    plusIcon?: JSX.Element;
    minusIcon?: JSX.Element;
    moveIcon?: JSX.Element;
    toolbox?: JSX.Element;
    toolboxIcon?: JSX.Element;
}

export interface IDesignerStates {
    isToolboxExtend: boolean;
}

export default class VDesigner extends Base<IVDesignerProps, IDesignerStates> {
    stage: Konva.Stage;
    constructor(props) {
        super(props);
        this.state = { isToolboxExtend: false };
    }
    componentDidMount() {
        if (this.props.isAutoSize) {
            if (!this.stage) {
                let size = getSize('v-designer-autosize');
                if (size.width != 0) {
                    this.stage = new Konva.Stage({
                        container: this.props.containerName ? this.props.containerName : 'v-designer',
                        width: size.width,
                        height: size.height
                    });
                }
                else {
                    this.stage = new Konva.Stage({
                        container: this.props.containerName ? this.props.containerName : 'v-designer'
                    });
                }
            }
            autoSize('v-designer-autosize', (size: ISize) => {
                this.stage.width(size.width);
                this.stage.height(size.height);
            });
        }
        else {
            if (!this.stage) {
                this.stage = new Konva.Stage({
                    container: this.props.containerName ? this.props.containerName : 'v-designer',
                    width: this.props.width as number,
                    height: this.props.height as number
                });
            }
        }
        /*var scaleBy = 1.1;
        this.stage.on('wheel', (e) => {
            e.evt.preventDefault();
            var oldScale = this.stage.scaleX();
            var pointer = this.stage.getPointerPosition();
            if (pointer) {
                var mousePointTo = {
                    x: (pointer.x - this.stage.x()) / oldScale,
                    y: (pointer.y - this.stage.y()) / oldScale,
                };
                var newScale =
                    e.evt.deltaY > 0 ? oldScale * scaleBy : oldScale / scaleBy;

                this.stage.scale({ x: newScale, y: newScale });

                var newPos = {
                    x: pointer.x - mousePointTo.x * newScale,
                    y: pointer.y - mousePointTo.y * newScale,
                };
                this.stage.position(newPos);
            }
        });*/
        this.props.nodeItems?.forEach((node: IVDesignerElementProps | IVDesignerGroupProps | IVDesignerConnectionProps, nodeIndex) => {
            var layer = new Konva.Layer({
            });
            this.stage.add(layer);
            if (node.type == DesignerNodeType.Element) {
                let designerElement = new VDesignerElement(layer, node as IVDesignerElementProps);
                designerElement.draw();
            }
            else if (node.type == DesignerNodeType.Group) {
                let designerGroup = new VDesignerGroup(layer, node as IVDesignerGroupProps);
                designerGroup.draw();
            }
            else if (node.type == DesignerNodeType.Connection) {
                let designerConnection = new VDesignerConnection(layer, node as IVDesignerConnectionProps);
                designerConnection.draw();
            }
        });
    }
    public render() {
        return (<div id='v-designer-autosize' className='v-designer-autosize' style={{ height: this.props.autosizeHeight }}>
            <Den.Components.PositionArea>
                <Den.Components.VBoundary>
                    <div id={this.props.containerName ? this.props.containerName : 'v-designer'} className={this.getClassName('v-designer')} style={this.getStyle()}>
                    </div>
                    {/*<Den.Components.Position category={Den.Components.PositionCategory.Area} type={Den.Components.PositionType.RightTop}>
                        <Den.Components.X gap='0.6em' margin='1em' padding='0.6em 1em' borderRadius='1em' backgroundColor={Den.Components.ColorType.Light}>
                            <Den.Components.X gap='0.2em'>
                                {this.props.plusIcon ? <Den.Components.VSvg>{this.props.plusIcon}</Den.Components.VSvg> : <Den.Components.VText size={Den.Components.SizeType.Small} content='➕' />}
                                <Den.Components.VLabel caption={'100%'} />
                                {this.props.minusIcon ? <Den.Components.VSvg>{this.props.minusIcon}</Den.Components.VSvg> : <Den.Components.VText size={Den.Components.SizeType.Small} content='➖' />}
                            </Den.Components.X>
                            <Den.Components.VLine category={Den.Components.LineCategory.Vertical} backgroundColor={Den.Components.ColorType.Placeholder} />
                            {this.props.moveIcon ? <Den.Components.VSvg>{this.props.moveIcon}</Den.Components.VSvg> : <Den.Components.VText content='◉' />}
                        </Den.Components.X>
                    </Den.Components.Position>*/}
                    {!!this.props.toolbox && <Den.Components.Position category={Den.Components.PositionCategory.Area} type={Den.Components.PositionType.Right}>
                        <Den.Components.VBoundary borderStyle='solid' borderColor={Den.Components.ColorType.Border} borderWidth='1px' padding='0.6em' backgroundColor={Den.Components.ColorType.White} style={{ minHeight: '100vh', cursor: 'pointer' }} onClick={() => { this.setState({ isToolboxExtend: true }) }}>
                            <Den.Components.YMiddle style={{ minHeight: '100vh' }} cross={Den.Components.YCrossType.Center}>
                                {!!this.state.isToolboxExtend && this.props.toolbox}
                                {!!(!this.state.isToolboxExtend && this.props.toolboxIcon) && <Den.Components.VSvg>{this.props.toolboxIcon}</Den.Components.VSvg>}
                            </Den.Components.YMiddle>
                        </Den.Components.VBoundary>
                    </Den.Components.Position>}
                </Den.Components.VBoundary>
            </Den.Components.PositionArea>
        </div>);
    }
}
